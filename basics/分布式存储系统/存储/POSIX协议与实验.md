# 使用 FUSE 实现自己的 POSIX 文件存储服务

## POSIX 是什么？

POSIX（Portable Operating System Interface，可移植操作系统接口）是一套由 IEEE 定义的标准化应用程序编程接口（API），
旨在提高软件在不同操作系统（尤其是类 UNIX 系统）之间的可移植性。它并不是传统意义上的“协议”（如 HTTP），
而是一组接口规范，定义了应用程序如何与操作系统交互，包括文件操作、进程管理、线程控制等。

对于文件存储，POSIX 提供了一套标准接口，例如：
- `open`：打开或创建文件。
- `read`：读取文件内容。
- `write`：写入文件内容。
- `stat`：获取文件属性。
- `readdir`：读取目录内容。

这些接口被广泛应用于 UNIX/Linux 系统，任何符合 POSIX 标准的操作系统或存储服务都可以让依赖这些接口的应用程序无感知地运行。

### POSIX 的核心原理

POSIX 的核心在于**抽象和标准化**：
1. **接口标准化**：POSIX 定义了函数的签名、参数和行为。例如，`open()` 在任何 POSIX 兼容系统上的用法和返回值语义一致。
2. **底层无关性**：应用程序只需调用 POSIX 接口，无需关心底层是本地文件系统（如 ext4）、网络文件系统（如 NFS），还是自定义实现。
3. **可替换性**：只要底层系统实现了 POSIX 接口，应用程序就可以无缝切换底层存储。

例如，一个使用 `open` 和 `write` 的备份工具可以在本地磁盘和云存储间切换，只要两者都提供 POSIX 兼容接口。这种解耦提高了软件的可移植性和灵活性。

---

## POSIX 的工作原理

在类 UNIX 系统中，POSIX 接口通过操作系统的**虚拟文件系统（VFS）**层实现。VFS 是一个抽象层，负责：
1. **路由调用**：将应用程序的 POSIX 调用（如 `open("/path/file.txt")`）转发到具体文件系统实现。
2. **挂载管理**：不同的文件系统（如 ext4、NFS）可以挂载到特定路径，VFS 根据路径决定调用哪个实现。

当你实现自己的 POSIX 接口时，需要将你的实现注册到 VFS 中，让操作系统知道某个路径（例如 `/mnt/mystorage`）由你的代码处理。这通常通过以下方式实现：
- **内核模块**：直接在内核态实现文件系统并注册到 VFS。
- **用户空间文件系统（FUSE）**：在用户空间实现逻辑，通过 FUSE 内核模块与 VFS 交互。

---

## 使用 FUSE 实现自定义 POSIX 文件存储

FUSE（Filesystem in Userspace，用户空间文件系统）是一个强大的工具，允许开发者在用户空间实现文件系统，并通过内核模块将其挂载到操作系统中，
提供 POSIX 接口。相比内核模块，FUSE 的优势在于开发简单、调试方便，非常适合实验和原型开发。

### 实现步骤

1. **定义存储逻辑**：创建一个自定义存储服务（例如基于内存、磁盘或云端），实现 POSIX 接口的核心功能。
2. **实现 FUSE 接口**：将存储逻辑映射到 FUSE 操作（如 `fuse_operations` 中的函数）。
3. **挂载文件系统**：通过 FUSE 将实现挂载到指定路径（如 `/mnt/mystorage`）。
4. **验证**：使用标准工具（如 `echo` 和 `cat`）测试文件读写。

下面是一个基于内存的简单文件系统实现示例，使用 C++ 和 FUSE。

---

## 示例代码：内存文件系统

以下代码实现了一个基于内存的 POSIX 文件系统，支持文件的创建、写入和读取，并通过调试输出来验证调用的是自定义接口。

### 完整代码(见 [main.cpp](./cpp_impl/main.++))

## 编译与运行
### 环境准备
    * 操作系统: Linux (Debian11 arm64)
    * 安装依赖:
     ```shell
     sudo apt-get update
     sudo apt-get install libfuse-dev g++ -y
     ```

### 编译
    ```shell
    g++ -std=c++11 -Wall main.c++ -o myfs -lfuse -D_FILE_OFFSET_BITS=64
    ```
### 运行
    ```shell
    ./myfs /mnt/myfs
    ```

### 验证
    ```shell
    # 挂载
    mount | grep myfs
    # 卸载
    fusermount -u /mnt/myfs
    ```
